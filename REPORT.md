# ICFPC2025 Team Unagi ソルバー分析レポート

## コンテスト概要

- **コンテスト**: ICFP Programming Contest 2025
- **問題名**: "The Name of the Binding"
- **期間**: 2025年9月5日〜9月8日
- **チーム名**: Unagi
- **問題数**: 16問（3部屋〜90部屋の迷路探索問題）
- **総コミット数**: 389コミット（コンテスト期間中）

## 問題設定

コンテストの問題は、部屋とドアで構成されたグラフ構造の迷路を探索し、各部屋の色（ラベル）と接続関係を推定する問題です。探索計画を実行して観測結果を得て、元のグラフ構造と部屋の色を復元することが目標です。

### 問題インスタンス
```json
[
  {"problem":"probatio","size":3},
  {"problem":"primus","size":6},
  {"problem":"secundus","size":12},
  {"problem":"tertius","size":18},
  {"problem":"quartus","size":24},
  {"problem":"quintus","size":30},
  {"problem":"aleph","size":12},
  {"problem":"beth","size":24},
  {"problem":"gimel","size":36},
  {"problem":"daleth","size":48},
  {"problem":"he","size":60},
  {"problem":"vau","size":18},
  {"problem":"zain","size":36},
  {"problem":"hhet","size":54},
  {"problem":"teth","size":72},
  {"problem":"iod","size":90}
]
```

## アルゴリズム分析

### 1. SAT-based ソルバー群

#### wata_sat シリーズ (wata担当)

**基本アプローチ**: Cadical SAT ソルバーを使用した制約充足問題として定式化

**主要技術**:
- **AMO制約**: At-Most-One制約をペアワイズ（小規模）と逐次エンコーディング（大規模）で実装
- **対称性破壊**: First-use symmetry breaking で解空間を削減
- **変数エンコーディング**: 
  - `V[i][u]`: 時刻iで部屋u
  - `L[u][k]`: 部屋uの色k
  - `E[u][e][v][f]`: 部屋uのドアeが部屋vのドアfに接続

**進化過程**:

1. **wata_sat.rs**: 基本的なSAT定式化
   - Cadical SAT solver使用
   - 基本的な制約エンコーディング
   - グラフ再構築機能

2. **wata_sat2.rs**: RustSAT使用、複数ソルバー並列実行
   - Minisat, Glucose, Kissat の並列実行
   - 差分制約による推論強化
   - First-use symmetry breaking

3. **wata_sat3.rs**: 倍化率D=3、ガチャ関数による品質評価
   - 部屋を3倍に分割して状態管理
   - Super guess による階層的解法
   - 色変更機能付き

4. **wata_sat4.rs**: D=2、状態反転機能付き
   - 2倍分割での状態管理
   - ドアごとの状態反転フラグ
   - より効率的な制約エンコーディング

5. **wata_sat5.rs**: D=3、置換群による状態管理
   - 3次置換群による状態遷移
   - より複雑な状態変化モデル
   - 高度な対称性処理

6. **wata_sat6.rs**: 並列化版（推定）
   - 並列処理による高速化

#### chokudai_sat シリーズ (chokudai担当)

**基本アプローチ**: SAT + 探索計画生成 + 品質評価

**主要技術**:
- **バランス計画生成**: 各ドア方向を均等に使用する探索計画
- **ガチャ関数**: 期待値と実測値の差による品質評価
  ```rust
  pub fn gacha(n: usize, plan: &[(Option<usize>, usize)], labels: &[usize]) -> f64 {
      // ラベル-ドア分布の期待値と実測値の差を計算
      let mut label_door = mat![0; 4; 6];
      // ... 実装詳細
  }
  ```
- **グラフ再構築**: CNF制約からのグラフ復元
- **色制約**: 部屋の色変更機能

**特徴**:
- D=2（部屋倍化）での複雑な状態管理
- 並列SAT求解
- 動的な制約追加
- 最終日に15回以上の集中的な改良

#### iwiwi_sat.rs (iwiwi担当)

**基本アプローチ**: シンプルなSAT定式化

**主要技術**:
- 直接的な変数エンコーディング
- 無向グラフ制約の実装
- 観測制約の直接実装
- 事前記録された探索結果の使用

### 2. ルーティング・最適化アルゴリズム

#### iwiwi_routing シリーズ (iwiwi担当)

**基本アプローチ**: 探索計画の最適化

**主要技術**:
- **カバレッジ評価**: 各部屋・ドアの訪問回数による評価
  ```rust
  fn coverage(local_judge: &LocalJudge, plan: &Vec<usize>) -> (f32, f32, f32) {
      // カバレッジ率、正規化エントロピー、完全カバレッジフラグを計算
  }
  ```
- **エントロピー計算**: 訪問分布の均一性評価
- **貪欲探索**: 各ステップで最適なドア選択

#### iwiwi_routing_hc.rs

**基本アプローチ**: 山登り法による局所探索

**主要技術**:
- **近傍操作**: reverse, swap, change操作による計画改良
- **評価関数**: カバレッジ + エントロピーの重み付き和
- **複数インスタンス評価**: 訓練用・テスト用データでの評価
- **Instance構造**: グラフ表現と隣接関係管理

### 3. 進化的アルゴリズム

#### iwiwi_evo_gen276.rs

**基本アプローチ**: SAT + 進化的最適化

**主要技術**:
- **対称性破壊**: 矩形first-use SBP
- **差分制約**: 同一ラベル・同一遷移での区別制約
- **エッジ変数**: 複雑な接続制約
- **等化制約**: 同一条件での一貫性保証
- **組み合わせヘルパー**: 計画間の差分計算

### 4. ハイブリッドアプローチ

#### chokudai_wata_sat.rs

**基本アプローチ**: 複数手法の統合

**主要技術**:
- **SameTable**: 部屋の同一性推論
- **DFS探索**: 制約伝播による推論
- **SAT統合**: 推論結果をSAT制約に変換
- **AMO/ALO制約**: wataとchokudaiの技術統合

## 開発タイムライン

### 9月3日-5日: 基盤構築期
- インフラストラクチャ構築
- 基本的なJudgeシステム実装
- 初期SAT定式化
- 問題理解とアプローチ検討

### 9月6日: アルゴリズム多様化期
- **iwiwi**: ルーティングアルゴリズム開発開始
  - `routing` → `routing greedy v2` → `routing HC`
- **wata**: RustSAT導入 (`rustsat`)
- **進化的アプローチ**: `evo`, `evo 2 (wip)`
- 複数のアプローチが並行開発開始

### 9月7日: SAT最適化期
- **wata**: SAT3-6の連続開発
  - `wata_sat3`, `wata_sat4`, `wata_sat5`の立て続けの実装
- **chokudai**: SAT solver改良継続
- **iwiwi**: 進化的アルゴリズムの文書化

### 9月8日: 最終調整期（最も活発）
- **chokudai**: 15回以上の`chokudai_sat.rs`更新
  - "AMO入れてみた", "がちゃを消した", "対称性破壊した"等の集中的改良
- **wata**: 並列化版実装（`6par`, `par`）
- **ガチャ機能**: 品質評価システム改良
- **最終提出**: スコア集計とベストソルバー選定

## チーム貢献分析

### 主要メンバー

1. **chokudai (Naohiro Takahashi)**: 113コミット
   - SAT定式化のリーダー
   - 品質評価システム（ガチャ）開発
   - 最終日の集中的な改良
   - 実用的なソルバー実装

2. **wata**: 53コミット
   - 高度なSAT技術実装
   - 並列化・最適化担当
   - 複数SAT solver統合
   - 理論的に洗練されたアプローチ

3. **iwiwi (Takuya Akiba)**: 2コミット（但し重要な貢献）
   - ルーティング・進化的アルゴリズム
   - 探索計画最適化
   - 異なるアプローチによる多様性提供

4. **その他のメンバー**:
   - **Toshiki Kataoka**: 可視化・インフラ
   - **Kentaro IMAJO**: API・Web interface
   - **sulume**: 最終提出・スコア管理

## 技術的特徴

### 強み

1. **多様なアプローチ**: SAT、最適化、進化的アルゴリズムの組み合わせ
2. **高度なSAT技術**: AMO制約、対称性破壊、並列求解
3. **品質評価**: ガチャ関数による解の品質定量化
4. **スケーラビリティ**: 3-90部屋の幅広い問題サイズに対応
5. **並列化**: 複数ソルバーの同時実行による高速化

### 革新的要素

1. **倍化戦略**: 部屋を2倍・3倍に分割して状態管理
   - 複雑な状態変化を効率的にモデル化
   - より細かい制約表現が可能

2. **ハイブリッド推論**: 論理推論とSATの組み合わせ
   - SameTable による同一性推論
   - DFS + SAT の階層的解法

3. **動的制約**: 実行時の制約追加・調整
   - 探索結果に基づく制約強化
   - 適応的な問題解決

4. **品質評価システム**: ガチャ関数による定量的評価
   - 解の品質を数値化
   - 運要素の定量化と制御

## 実装の詳細

### SAT変数エンコーディング

```rust
// wata_sat.rs の例
fn V(n: usize, q: usize, i: usize, u: usize) -> i32 {
    // i番目に訪れた部屋がu
    (1 + (i * n) + u) as i32
}

fn L(n: usize, q: usize, u: usize, k: usize) -> i32 {
    // 部屋uの色がk
    (1 + n * q + (u * 4) + k) as i32
}

fn E(n: usize, q: usize, u: usize, e: usize, v: usize, f: usize) -> i32 {
    // 部屋uのドアeが部屋vのドアfに接続
    (1 + n * q + (n * 4) + (u * 6 * n * 6) + (e * n * 6) + v * 6 + f) as i32
}
```

### 制約の例

```rust
// パス制約: 各時刻で正確に一つの部屋にいる
for i in 0..q {
    // 少なくとも一つの部屋
    sat.add_clause((0..n).map(|u| V(n, q, i, u)));
    // 高々一つの部屋
    for u in 0..n {
        for v in (u + 1)..n {
            sat.add_clause([-V(n, q, i, u), -V(n, q, i, v)]);
        }
    }
}
```

## 結論

Team Unagiは、SAT技術を中核としながら、ルーティング最適化、進化的アルゴリズム、ハイブリッド推論を組み合わせた包括的なアプローチを採用しました。特に最終日の集中的な改良により、高度に最適化されたソルバー群を完成させています。

### 成功要因

1. **技術的多様性**: 異なる専門性を持つメンバーによる多角的アプローチ
2. **継続的改良**: 特に最終日の集中的な最適化
3. **品質管理**: ガチャ関数による客観的評価
4. **並列化**: 複数手法の同時実行による効率化
5. **理論と実践**: 高度な理論的技術と実用的な実装の両立

コンテスト期間中の389コミットは、チームの高い技術力と協調性を示しており、各メンバーの専門性を活かした効率的な開発体制が構築されていたことが分析から明らかです。

---

*このレポートは、icfpc-unagi/icfpc2025リポジトリのソースコード分析とgitコミット履歴に基づいて作成されました。*
